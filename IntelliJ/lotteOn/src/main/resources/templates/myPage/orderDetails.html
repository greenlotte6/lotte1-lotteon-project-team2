<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="/css/myPage/layout.css">
    <link rel="stylesheet" href="/css/myPage/myPageMain.css">
    <link rel="stylesheet" href="/css/common/table-main.css">
    <link rel="stylesheet" href="/css/common/table-sub.css">
    <link rel="stylesheet" href="/css/myPage/modal.css">
    <link rel="stylesheet" href="/css/myPage/searchPeriod.css">
    <link rel="stylesheet" href="/css/index_layout.css">
    <link rel="stylesheet" href="/css/common/header.css">
    <link rel="stylesheet" href="/css/myPage/pagination.css">
    <link rel="stylesheet" href="/css/myPage/starRating.css">
    <script src="/js/myPage/searchPeriod.js"></script>
    <script src="/js/myPage/modal.js"></script>
    <script src="/js/headerMenu.js"></script>

    <script>
        // 구매확정
        document.addEventListener('DOMContentLoaded', function() {
            let selectedBtn = null; // 어떤 버튼에서 모달을 띄웠는지 저장

            // 모든 구매확정 버튼에 클릭 이벤트 등록
            document.querySelectorAll('.purchase_confirm_btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    selectedBtn = this; // 클릭한 버튼 저장
                });
            });

            // 모달 '확인' 버튼
            document.getElementsByClassName('modalConfirmBtn')[0].addEventListener('click', function() {
                if (!selectedBtn) return;

                // 해당 행(tr)과 상태 셀(td) 찾기
                const tr = selectedBtn.closest('tr');
                const statusTd = tr.querySelectorAll('td')[2]; // 3번째 td (상태)
                const itemNo = selectedBtn.getAttribute('data-product-id');
                const modal = document.querySelector('.purchase_confirm_modal');

                // 서버에 구매확정 요청
                fetch('/my/order/confirm', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ itemNo: itemNo })
                })
                    .then(response => {
                        if (response.ok) {
                            // 상태 텍스트 변경
                            statusTd.textContent = '구매확정';
                            // 버튼 비활성화 또는 숨김 처리 (선택)
                            selectedBtn.disabled = true;
                            alert('구매확정 처리되었습니다.');

                            modal.style.display = 'none';

                        } else {
                            alert('구매확정 처리에 실패했습니다.');
                        }
                    })
            });
        })
    </script>
</head>
<body>
    <div id="wrapper">
        <!-- 헤더 시작 -->
        <th:block th:include="/common/header.html"/>
        <!-- 헤더 끝 -->
        <!-- 메인 시작 -->
        <main>
            <!--<th:block th:insert="/myPage/inc/myShoppingInfo.html"></th:block>-->
            <section class="content">
                <!-- 왼쪽 사이드바 -->
                <th:block th:include="/myPage/inc/sidebar.html"/>
                <!-- 사이드바 끝-->
                <!-- 오른쪽 글 -->
                <article class="main_content_side">
                    <div class="ad">
                        <img th:src="@{/upload/{image}(image=${banner.sName})}"
                             th:style="'width:' + ${banner.width} + 'px;'
                                            +'height:' + ${banner.height} + 'px;'"
                             onerror="this.src='/images/가정의달.PNG';"
                             th:attr="onclick=|location.href='${banner.link}'|"
                             alt="lotteOn">
                    </div>
                    <div class="order-details">
                        <div class="title-area">
                            <h1>전체주문내역</h1>
                        </div>
                        <div class="searchSpace">
                            <p>기간조회</p>
                            <label>
                                <input type="radio" name="choice" value="7">
                                <span>1주일</span>
                            </label>
                            <label>
                                <input type="radio" name="choice" value="15">
                                <span>15일</span>
                            </label>
                            <label>
                                <input type="radio" name="choice" value="31">
                                <span>1개월</span>
                            </label>
                            <label>
                                <input type="radio" name="choice" value="3">
                                <span>직접입력</span>
                            </label>
                            <form class="search_form" action="#">
                                <input type="date" class="datepicker" id="startDate">
                                ~
                                <input type="date" class="datepicker" id="endDate">
                                <select name="" id="">
                                    <option value="">전체</option>
                                    <option value="">입금대기</option>
                                    <option value="">결제완료</option>
                                    <option value="">출고지시</option>
                                    <option value="">상품준비중</option>
                                    <option value="">배송중</option>
                                    <option value="">배송완료</option>
                                    <option value="">구매확정</option>
                                    <option value="">취소</option>
                                    <option value="">교환</option>
                                    <option value="">반품</option>
                                </select>
                                <input type="search" placeholder="검색어를 입력하세요">
                                <button>검색</button>
                            </form>
                        </div>
                        <div class="order-details-table">
                            <table class="table-main">
                                <tbody>
                                    <tr>
                                        <th>날짜</th>
                                        <th>상품정보</th>
                                        <th>상태</th>
                                        <th>확인/신청</th>
                                    </tr>
                                </tbody>
                                <tbody>
                                    <tr th:each="orderInfo, i : ${orderInfoPagingDTO.dtoList}">
                                        <td th:text="${#strings.substring(orderInfo.orderDate, 0, 10)}"></td>
                                        <td class="product-info">
                                            <div class="img-container">
                                                <img class="img" th:src="${orderInfo.productImage}" alt="">
                                            </div>
                                            <div class="text-area">
                                                <p th:text="${'주문번호 : ' + orderInfo.orderNo}"></p>
                                                <p th:text="${'상호명 : ' + orderInfo.seller.company}"></p>
                                                <p th:text="${'상품명 : ' + orderInfo.product.prodName}"></p>
                                                <p th:text="${'수량 : ' + orderInfo.orderItem.itemCount + '개'}"></p>
                                                <p th:text="${'가격 : ' + #numbers.formatInteger(orderInfo.orderItem.itemPrice, 3, 'COMMA') + '원'}"></p>
                                            </div>
                                        </td>
                                        <td th:text="${orderInfo.orderStatus}"></td>
                                        <td>
                                            <input type="button" class="orderdetails-btn purchase_confirm_btn" value="구매확정"
                                                   th:data-product-id="${orderInfo.orderItem.itemNo}"
                                                   th:data-prod-name="${orderInfo.product.prodName}"
                                                   th:data-orderStatus="${orderInfo.orderStatus}">
                                            <input type="button" class="orderdetails-btn product_review_btn" value="상품평쓰기"
                                                   th:data-product-id="${orderInfo.orderItem.itemNo}"
                                                   th:data-prod-name="${orderInfo.product.prodName}"
                                                   th:data-orderStatus="${orderInfo.orderStatus}"
                                                   th:data-prod-id="${orderInfo.product.prodNo}">
                                            <input type="button" class="orderdetails-btn return_request_btn" value="반품신청"
                                                   th:data-orderDate="${#strings.substring(orderInfo.orderDate, 0, 10)}"
                                                   th:data-itemNo="${orderInfo.orderItem.itemNo}"
                                                   th:data-prodName="${orderInfo.product.prodName}"
                                                   th:data-company="${orderInfo.seller.company}"
                                                   th:data-itemCount="${orderInfo.orderItem.itemCount}"
                                                   th:data-itemPrice="${orderInfo.orderItem.itemPrice}"
                                                   th:data-productImage="${orderInfo.productImage}"
                                                   th:data-itemDiscount="${orderInfo.orderItem.itemDiscount}"
                                                   th:data-orderStatus="${orderInfo.orderStatus}"
                                                   th:data-orderItemNo="${orderInfo.orderItem.itemNo}">
                                            <input type="button" class="orderdetails-btn exchange_request_btn" value="교환신청"
                                                   th:data-orderDate="${#strings.substring(orderInfo.orderDate, 0, 10)}"
                                                   th:data-itemNo="${orderInfo.orderItem.itemNo}"
                                                   th:data-prodName="${orderInfo.product.prodName}"
                                                   th:data-company="${orderInfo.seller.company}"
                                                   th:data-itemCount="${orderInfo.orderItem.itemCount}"
                                                   th:data-itemPrice="${orderInfo.orderItem.itemPrice}"
                                                   th:data-productImage="${orderInfo.productImage}"
                                                   th:data-itemDiscount="${orderInfo.orderItem.itemDiscount}"
                                                   th:data-orderStatus="${orderInfo.orderStatus}"
                                                   th:data-orderItemNo="${orderInfo.orderItem.itemNo}">
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                            <div class="notice-footer">
                                <div class="pagination">
                                    <a class="prev" th:if="${orderInfoPagingDTO.prev}" th:href="@{/my/review(pg=${orderInfoPagingDTO.start - 1}, size=${orderInfoPagingDTO.size})}">이전</a>
                                    <th:block th:each="i: ${#numbers.sequence(orderInfoPagingDTO.start, orderInfoPagingDTO.end)}">
                                        <a th:href="@{/my/order(pg=${i}, size=${orderInfoPagingDTO.size})}" th:text="${i}" th:class="${i == orderInfoPagingDTO.pg ? 'active' : ''}"></a>
                                    </th:block>
                                    <a class="next" th:if="${orderInfoPagingDTO.next}" th:href="@{/my/review(pg=${orderInfoPagingDTO.end + 1}, size=${orderInfoPagingDTO.size})}">다음</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </article>
            </section>
        </main>
        <!-- 메인 끝 -->
        <!--구매확정 모달 팝업-->
        <div class="modal purchase_confirm_modal">
            <div class="modal_popup">
                <div class="modal-wrapper">
                    <div class="modal-header">
                        <div class="modal-name">
                            <p>구매확정</p>
                        </div>
                        <div class="exit" style="cursor: pointer;">
                            <p class="modalClose">X</p> <!-- 수정 예정 -->
                        </div>
                    </div>
                    <div class="modal-main table-sub">
                        <div class="purchase_confirm_content" style="margin: 80px; font-size: 20px;">
                            <p>상품을 받으셨나요?</p>
                            <p>상품을 받으신 분만 구매확정을 해주세요.</p>
                        </div>
                        <div class="btn">
                            <input type="submit" value="확인" class="modalConfirmBtn">
                            <input type="button" value="취소" class="modalClose">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!--상품평 모달 팝업-->
        <div class="modal product_review_modal">
            <div class="modal_popup">
                <div class="modal-wrapper">
                    <div class="modal-header">
                        <div class="modal-name">
                            <p>상품평 작성</p>
                        </div>
                        <div class="exit" onclick="location.href='#'" style="cursor: pointer;">
                            <p class="modalClose">X</p> <!-- 수정 예정 -->
                        </div>
                    </div>
                    <div class="modal-main table-sub">
                        <table>
                            <tbody>
                                <tr>
                                    <td>상품명</td>
                                    <td id="modalProdName">상품</td>
                                </tr>
                                <tr>
                                    <td>만족도</td>
                                    <td>
                                        <div class="star-rating">
                                            <input type="radio" id="star5" name="rating" value="5"><label for="star5">★</label>
                                            <input type="radio" id="star4" name="rating" value="4"><label for="star4">★</label>
                                            <input type="radio" id="star3" name="rating" value="3"><label for="star3">★</label>
                                            <input type="radio" id="star2" name="rating" value="2"><label for="star2">★</label>
                                            <input type="radio" id="star1" name="rating" value="1"><label for="star1">★</label>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td>내용</td>
                                    <td>
                                        <textarea name="review_content"></textarea>
                                    </td>
                                </tr>
                                <tr>
                                    <td>사진</td>
                                    <td class="file">
                                        <input type="file" name="file1"/>
                                        <input type="file" name="file2"/>
                                        <input type="file" name="file3"/>
                                    </td>
                                </tr>
                                
                            </tbody>
                        </table>
                        <div class="btn">
                            <input type="submit" value="작성완료" class="modal_review_btn">
                            <input type="submit" value="취소" class="modalClose">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                let selectedBtn = null; // 어떤 버튼에서 모달을 띄웠는지 저장

                document.querySelectorAll('.product_review_btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        selectedBtn = this; // 클릭한 버튼 저장
                    });
                });

                // 모달 '확인' 버튼
                document.getElementsByClassName('modal_review_btn')[0].addEventListener('click', function() {

                    // 1. type(라디오) 값 가져오기
                    const rating = document.querySelector('input[name="rating"]:checked');
                    if (!rating) {
                        alert('만족도를 체크해주세요.');
                        return;
                    }

                    // 2. content(사유) 값 가져오기
                    const content = document.querySelector('textarea[name="review_content"]').value;
                    if (!content) {
                        alert('내용을 입력해주세요.');
                        return;
                    }

                    const itemNo = selectedBtn.getAttribute('data-orderItemNo');
                    const tr = selectedBtn.closest('tr');
                    const statusTd = tr.querySelectorAll('td')[2];
                    const productId = selectedBtn.getAttribute('data-prod-id')

                    // 4. 서버로 데이터 전송 (JSON)
                    fetch('/my/order/review', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            rating: rating.value,
                            content: content,
                            itemNo: itemNo,
                            productId: productId
                        })
                    })
                        .then(response => {
                            if (response.ok) {
                                alert('상품리뷰 작성이 완료되었습니다.');
                                // 모달 닫기
                                document.querySelector('.product_review_modal').style.display = 'none';
                                // 폼 초기화 (선택)
                                document.querySelector('textarea[name="review_content"]').value = '';
                                document.querySelectorAll('input[name="type"]').forEach(radio => radio.checked = false);
                            } else {
                                alert('상품리뷰 작성을 실패했습니다.');
                            }
                        })
                        .catch(() => {
                            alert('서버 오류가 발생했습니다.');
                        });
                });
            })
        </script>
        <!--반품신청 모달 팝업-->
        <div class="modal return_request_modal">
            <div class="modal_popup">
                <div class="modal-wrapper">
                    <div class="modal-header">
                        <div class="modal-name">
                            <p>반품신청</p>
                        </div>
                        <div class="exit" onclick="location.href='#'" style="cursor: pointer;">
                            <p class="modalClose">X</p> <!-- 수정 예정 -->
                        </div>
                    </div>
                    <div class="modal-main">
                        <div class="title-area">
                            <h1>상품정보</h1>
                        </div>
                        <div class="order-info table-main">
                            <table>
                                <tbody>
                                    <tr>
                                        <th>날짜</th>
                                        <th>상품정보</th>
                                        <th>결제금액</th>
                                        <th>상태</th>
                                    </tr>
                                </tbody>
                                <tbody>
                                    <tr>
                                        <td id="returnModalOrderDate"></td>
                                        <td class="product-info">
                                            <div class="img-container">
                                                <img id="returnModalProductImage" class="img" src="" alt="">
                                            </div>
                                            <div class="text-area">
                                                <p id="returnModalOrderNo"></p>
                                                <p id="returnModalCompany"></p>
                                                <p id="returnModalProdName"></p>
                                                <p id="returnModalItemCount"></p>
                                                <p></p>
                                            </div>
                                        </td>
                                        <td>
                                            <p id="returnModalSellPrice"></p>
                                            <p id="returnModalDiscount"></p>
                                            <p id="returnModalTotalPrice"></p>
                                        </td>
                                        <td id="returnModalOrderStatus"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="return-Request table-sub">
                            <div class="title-area">
                                <h1>반품정보 입력</h1>
                            </div>
                            <table>
                                <tbody>
                                    <tr>
                                        <td>반품유형</td>
                                        <td>
                                            <label>
                                                <input type="radio" name="type" value="단순 변심">
                                                <span>단순 변심</span>
                                            </label>
                                            <label>
                                                <input type="radio" name="type" value="파손 및 불량">
                                                <span>파손 및 불량</span>
                                            </label>
                                            <label>
                                                <input type="radio" name="type" value="주문 실수">
                                                <span>주문 실수</span>
                                            </label>
                                            <label>
                                                <input type="radio" name="type" value="기타">
                                                <span>기타</span>
                                            </label>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>사유입력</td>
                                        <td>
                                            <textarea name="return_content"></textarea>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>사진첨부(선택)</td>
                                        <td class="file">
                                            <input type="file">
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                            <div class="btn">
                                <input type="button" value="반품신청" class="modal_return_btn">
                                <input type="button" value="취소" class="modalClose">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                let selectedBtn = null; // 어떤 버튼에서 모달을 띄웠는지 저장


                document.querySelectorAll('.return_request_btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        selectedBtn = this; // 클릭한 버튼 저장
                    });
                });

                // 모달 '확인' 버튼
                document.getElementsByClassName('modal_return_btn')[0].addEventListener('click', function() {

                    // 1. type(라디오) 값 가져오기
                    const type = document.querySelector('input[name="type"]:checked');
                    if (!type) {
                        alert('반품유형을 선택하세요.');
                        return;
                    }

                    // 2. content(사유) 값 가져오기
                    const content = document.querySelector('textarea[name="return_content"]').value;
                    if (!content) {
                        alert('사유를 입력하세요.');
                        return;
                    }

                    const itemNo = selectedBtn.getAttribute('data-orderItemNo');
                    const tr = selectedBtn.closest('tr');
                    const statusTd = tr.querySelectorAll('td')[2];

                    // 4. 서버로 데이터 전송 (JSON)
                    fetch('/my/order/return', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            type: type.value,
                            content: content,
                            itemNo: itemNo
                        })
                    })
                        .then(response => {
                            if (response.ok) {
                                alert('반품신청이 완료되었습니다.');
                                // 모달 닫기
                                document.querySelector('.return_request_modal').style.display = 'none';
                                // 폼 초기화 (선택)
                                statusTd.textContent = "반품신청";
                                document.querySelector('textarea[name="return_content"]').value = '';
                                document.querySelectorAll('input[name="type"]').forEach(radio => radio.checked = false);
                            } else {
                                alert('반품신청에 실패했습니다.');
                            }
                        })
                        .catch(() => {
                            alert('서버 오류가 발생했습니다.');
                        });
                });
            })
        </script>
        <!--교환신청 모달 팝업-->
        <div class="modal exchange_request_modal">
            <div class="modal_popup">
                <div class="modal-wrapper">
                    <div class="modal-header">
                        <div class="modal-name">
                            <p>교환신청</p>
                        </div>
                        <div class="exit" onclick="location.href='#'" style="cursor: pointer;">
                            <p class="modalClose">X</p> <!-- 수정 예정 -->
                        </div>
                    </div>
                    <div class="modal-main">
                        <div class="title-area">
                            <h1>상품정보</h1>
                        </div>
                        <div class="order-info table-main">
                            <table>
                                <tbody>
                                    <tr>
                                        <th>날짜</th>
                                        <th>상품정보</th>
                                        <th>결제금액</th>
                                        <th>상태</th>
                                    </tr>
                                </tbody>
                                <tbody>
                                    <tr>
                                        <td id="exchangeModalOrderDate"></td>
                                        <td class="product-info">
                                            <div class="img-container">
                                                <img id="modalProductImage" class="img" src="" alt="">
                                            </div>
                                            <div class="text-area">
                                                <p id="exchangeModalOrderNo"></p>
                                                <p id="exchangeModalCompany"></p>
                                                <p id="exchangeModalProdName"></p>
                                                <p id="exchangeModalItemCount"></p>
                                                <p></p>
                                            </div>
                                        </td>
                                        <td>
                                            <p id="exchangeModalSellPrice"></p>
                                            <p id="exchangeModalDiscount"></p>
                                            <p id="exchangeModalTotalPrice"></p>
                                        </td>
                                        <td id="exchangeModalOrderStatus"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="return-Request table-sub">
                            <div class="title-area">
                                <h1>교환정보 입력</h1>
                            </div>
                            <table>
                                <tbody>
                                    <tr>
                                        <td>반품유형</td>
                                        <td>
                                            <label>
                                                <input type="radio" name="type" value="단순 변심">
                                                <span>단순 변심</span>
                                            </label>
                                            <label>
                                                <input type="radio" name="type" value="파손 및 불량">
                                                <span>파손 및 불량</span>
                                            </label>
                                            <label>
                                                <input type="radio" name="type" value="주문 실수">
                                                <span>주문 실수</span>
                                            </label>
                                            <label>
                                                <input type="radio" name="type" value="기타">
                                                <span>기타</span>
                                            </label>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>사유입력</td>
                                        <td>
                                            <textarea name="exchange_content"></textarea>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>사진첨부(선택)</td>
                                        <td class="file">
                                            <input type="file" id="exchange_image" accept="image/*">
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                            <div class="btn">
                                <input type="button" value="교환신청" class="modal_exchange_btn">
                                <input type="button" value="취소" class="modalClose">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                let selectedBtn = null; // 어떤 버튼에서 모달을 띄웠는지 저장


                document.querySelectorAll('.exchange_request_btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        selectedBtn = this; // 클릭한 버튼 저장
                    });
                });

                // 모달 '확인' 버튼
                document.getElementsByClassName('modal_exchange_btn')[0].addEventListener('click', function() {

                    // 1. type(라디오) 값 가져오기
                    const type = document.querySelector('input[name="type"]:checked');
                    if (!type) {
                        alert('반품유형을 선택하세요.');
                        return;
                    }

                    // 2. content(사유) 값 가져오기
                    const content = document.querySelector('textarea[name="exchange_content"]').value;
                    if (!content) {
                        alert('사유를 입력하세요.');
                        return;
                    }

                    const itemNo = selectedBtn.getAttribute('data-orderItemNo');
                    const tr = selectedBtn.closest('tr');
                    const statusTd = tr.querySelectorAll('td')[2];

                    // 4. 서버로 데이터 전송 (JSON)
                    fetch('/my/order/exchange', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            type: type.value,
                            content: content,
                            itemNo: itemNo
                        })
                    })
                        .then(response => {
                            if (response.ok) {
                                alert('교환신청이 완료되었습니다.');
                                // 모달 닫기
                                document.querySelector('.exchange_request_modal').style.display = 'none';
                                // 폼 초기화 (선택)
                                statusTd.textContent = "교환신청";
                                document.querySelector('textarea[name="return_content"]').value = '';
                                document.querySelectorAll('input[name="type"]').forEach(radio => radio.checked = false);
                            } else {
                                alert('교환신청에 실패했습니다.');
                            }
                        })
                        .catch(() => {
                            alert('서버 오류가 발생했습니다.');
                        });
                });
            })
        </script>
        <!-- 푸터 시작 -->
        <th:block th:include="/common/footer.html"/>
        <!-- 푸터 끝 -->
    </div>
</body>
</html>